# 类加载器

#### 注意事项

该书的Java版本是8，在Java9中，类加载器有了新的名字，所以以下知识并不完全适合Java9以上版本。

#### 类加载器（P401-402）

Java编译器会为虚拟机转换源指令。虚拟机代码存储在以.class为扩展名的类文件中，每个类文件都包含某个类或者接口的定义和实现代码。这些类文件必须由一个程序进行解释，该程序能够将虚拟机的指令集翻译成目标机器的机器语言。

#### 类加载过程（P402）

虚拟机只加载程序执行时所需要的类文件。例如，假设程序从MyProgram.class开始运行，下面是虚拟机执行的步骤

1. 虚拟机有一个用于加载类文件的机制，它使用该机制来加载MyProgram类文件中的内容。
2. 如果MyProgram类拥有类型为另一个类的域，或者是拥有超类，那么这些类文件也会被加载。（加载某个类所依赖的所有类的过程叫做类的解析。）
3. 虚拟机执行MyProgram中的main方法。
4. 如果main方法或者main调用的方法要用到更多的类，那么接下来就会加载这些类。

每个Java程序至少拥有三个类加载器：

1. 引导类加载器
2. 扩展类加载器
3. 系统类加载器（有时也称应用类加载器）

#### 类加载器的层次结构（P403-404）

类加载器有一种父/子关系。除了引导类加载器外，每个类加载器都有一个父类加载器，根据规定，类加载器会为它的父类加载器提供一个机会，以便加载任何给定的类，并且只有在其父类加载器加载失败时，它才会加载该给定的类。例如，当要求系统类加载器加载一个系统类时，它首先要求扩展类加载器进行加载，该扩展类加载器则首先要求引导类加载器进行加载。引导类加载器会找到并加载rt.jar中的这个类，而无须其他类加载器做更多的搜索。

每个线程都有一个对类加载器的引用，称为上下文类加载器。主线程的上下文类加载器是系统类加载器。当新线程创建时，它的上下文类加载器会被设置成为创建该线程的上下文类加载器。因此，如果你不做任何特殊的操作，那么所有线程就都会将它们的上下文类加载器设置为系统类加载器。

但是，我们也可以通过下面的调用将其设置成为任何类加载器

```text
Thread t = Thread.currentThred();
t.setContextClassLoader(loader);
```

#### 类加载器作为命名空间（P404-405）

包的命名是为了消除名字冲突。在同一个虚拟机中，可以有两个类，它们的类名和包名都是相同的。类是由它的全名和类加载器来确定的。

#### 自定义类加载器（P405）

如果要编写自己的类加载器，只需要继承ClassLoader类，然后覆盖下面这个方法

```text
findClass(String className)
```

ClassLoader超类的loadClass方法用于将类的加载操作委托给其父类加载器去进行，只有当该类尚未加载并且父类加载器也无法加载该类时，才调用findClass方法。

#### 字节码校验（P410）

当类加载器将新加载的Java平台类的字节码传递给虚拟机时，这些字节码首先要接受校验器的校验。校验器负责检查那些指令无法执行的明显有破坏性的操作。除了系统类外，所有的类都要被校验。

下面是校验器执行的一些检查：

* 变量要在使用之前进行初始化
* 方法调用与对象引用类型之间要匹配
* 访问私有数据和方法的规则没有被违反
* 对本地变量的访问都落在运行时堆栈内
* 运行时堆栈没有溢出

#### 相关API（P409\)

* java.lang.Class 1.0
  * ClassLoader getClassLoader\(\)
    * 获取加载该类的类加载器
* java.lang.ClassLoader 1.0
  * ClassLoader getParent\(\) 1.2
    * 返回父类加载器，如果父类加载器是引导类加载器，则返回null。
  * static ClassLoader getSystemClassLoader\(\) 1.2
    * 获得系统类加载器，即用于加载第一个应用类的类加载器
  * protected Class findClass\(String name\) 1.2
    * 类加载器应该覆盖该方法，以查找类的字节码，并通过调用defineClass方法将字节码传给虚拟机。
  * Class defineClass\(String name, byte\[\] byteCodeData, int offset, int length\)
    * 将一个新的类添加到虚拟机中，其字节码在给定的数据范围中。
* java.net.URLClassLoader 1.2
  * URLClassLoader\(URL\[\] urls\)
  * URLClassLoader\(URL\[\] urls, ClassLoader parent\)
    * 构建一个类加载器，它可以从给定的URL处加载类。
* java.lang.Thread 1.0
  * ClassLoader getContextClassLoader\(\) 1.2
    * 获取类加载器，该线程的创建者将其指定为执行该线程时最适合使用的类加载器。
  * void setContextClassLoader\(ClassLoader loader\) 1.2
    * 为该线程中的代码设置一个类加载器，以获取要加载的类。如果在启动一个线程时没有显式地设置上下文类加载器，则使用父线程的上下文类加载器。

