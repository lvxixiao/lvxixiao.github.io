# 存储引擎

## MyISAM

#### 特点

MyISAM不支持事务、也不支持外键，其优势是访问的速度快，对事务完整性没有要求或者以SELECT、INSERT为主的应用基本上都可以使用这个引擎来创建表。

#### 存储

每个MyISAM在磁盘上存储成3个文件，其文件名都和表名相同，但扩展名分别是

* .frm\(存储表定义\)
* .MYD\(MYData, 存储数据\)
* .MYI\(MYIndex, 存储索引\)

数据文件可以和索引文件放置在不同的目录，平均分布IO，获得更快的速度。

MyISAM表还支持3种不同的存储格式

* 静态\(固定长度\)表
* 动态表
* 压缩表

**静态表**

静态表是默认的存储格式，表中的字段都是非变长字段，这样每个记录都是固定长度的。静态表的数据在存储时按照列的宽度定义补足空格，但是在应用访问的时候并不会得到这些空格，这些空格在返回给应用之前已经去掉。但是也有些需要特别注意的问题，如果需要保存的内容后面本来就带有空格，那么在返回结果的时候也会被去掉。

静态表的优点是存储非常迅速，容易缓存，出现故障容易恢复。缺点是占用的空间通常比动态表多。

**动态表**

动态表中包含变长字段，记录不是固定长度的，这样存储的优点是占用的空间相对较少，但是频繁地更新和删除记录会产生碎片，需要定期执行OPTIME TABLE语句或myisamchk -r命令来改善性能，并且在出现故障时恢复相对比较困难。

**压缩表**

压缩表由myisampack工具创建，占据非常小的磁盘空间。因为每个记录是被单独压缩的，所以只有非常小的访问开支。

## MERGE

#### 特点

MERGE存储引擎是一组MyISAM表的组合，这些MyISAM表必须结构完全相同。MERGE表本身并没有数据，

对MEGRE类型的表可以进行查询、更新、删除操作，这些操作实际上是对内部的MyISAM表进行的。

对于插入操作，只能插入第一或者最后一个表上。这也是MERGE表和分区表的区别，MERGE表并不能智能地将记录写到对应地表中，而分区表是可以的。

对MERGE表进行DROP操作，这个操作只是删除MERGE的定义，对内部的表没有任何影响。

#### 存储

MEGRE表在磁盘上保留两个文件，文件名以表的名字开始，一个.frm文件存储表定义，另一个.MRG文件包含组合表的信息，包括MERGE表由哪些表组成、插入新的数据时的依据。

## InnoDB

#### 特点

InnoDB存储引擎提供了具有提交、回滚和崩溃恢复能力的事务安全。但是对比MyISAM的存储引擎，InnoDB写的处理效率差一些，并且会占用更多的磁盘空间以保留数据和索引。

InnoDB还有其他特点，如自动增长列、外键索引。

#### 存储

InnoDB存储表和索引有以下两种方式

* 使用共享表空间存储
* 使用多表空间存储

## MEMORY

#### 特点

MEMORY存储引擎使用存在于内存中的内容来创建表。因此它的数据是放在内存中的，访问非常地快。但是一旦服务关闭，表中的数据就会丢失掉。

MEMORY表的索引默认使用HASH索引，可以指定为BTREE索引。

MEMORY类型的存储引擎主要用于那些内容变化不频繁的代码表，或者作为统计操作的中间结果表，便于高效地对中间结果进行分析并得到最终的统计结果。对存储引擎为MEMORY的表进行更新操作要谨慎，因为数据并没有实际写入到磁盘中。

#### 存储

每个MEMORY表只实际对应一个磁盘文件，格式是.frm。数据存放在内存中。

## TokuDB

#### 特点

TokuDB是一个高性能、支持事务处理的MySQL和MariaDB的存储引擎，具有高扩展性、高压缩率、高效的写入性能，支持大多数在线DDL操作。

#### 特性

通过对比InnoDB，可以看出TokuDB主要有以下几项特性

* 使用Fractal树索引保证高效的插入性能
* 优秀的压缩特性，比InnoDB高近10倍
* Hot Schema Changes特性支持在线创建索引和添加、删除属性列等DDL操作
* 使用Bulk Loader达到快速加载大量数据
* 支持ACID和MVCC

#### 适用场景

* 日志数据，因为日志通常插入频繁且存储量大
* 历史数据，通常不会再有写操作，可以利用TokuDB的高压缩特性进行存储
* 在线DDL较频繁的场景，使用TokuDB可以大大增加系统的可用性

## 常用存储引擎对比

| 特点 | MyISAM | InnoDB | MEMORY | MERGE | NDB |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 存储限制 | 有 | 64TB | 有 | 没有 | 有 |
| 事务安全 |  | 支持 |  |  |  |
| 锁机制 | 表锁 | 行锁 | 表锁 | 表锁 | 行锁 |
| B树索引 | 支持 | 支持 | 支持 | 支持 | 支持 |
| 哈希索引 |  |  | 支持 |  | 支持 |
| 全文索引 | 支持 |  |  |  |  |
| 集群索引 |  | 支持 |  |  |  |
| 数据缓存 |  | 支持 | 支持 |  | 支持 |
| 索引缓存 | 支持 | 支持 | 支持 | 支持 | 支持 |
| 数据可压缩 | 支持 |  |  |  |  |
| 空间使用 | 低 | 高 | N/A | 低 | 低 |
| 内存使用 | 低 | 高 | 中等 | 低 | 高 |
| 批量插入的速度 | 高 | 低 | 高 | 高 | 高 |
| 支持外键 |  | 支持 |  |  |  |

## 如何选择合适的存储引擎

在选择存储引擎时，应根据应用特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。

#### MyISAM

默认的MySQL插件式存储引擎。如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常适合的。MyISAM是在Web、数据仓储和其他应用环境下最常使用的存储引擎之一。

#### InnoDB

用于事务处理应用程序，支持外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询外，还包括很多的更新、删除操作，那么InnoDB存储引擎应该是比较合适的选择。InnoDB存储引擎除了有效地降低由于删除和更新导致地锁定，还可以确保事务地完整提交和回滚，对于类似计费系统或者财务系统等对数据准确性要求比较高地系统，InnoDB都是合适地选择。

#### MEMORY

将所有数据保存在RAM中，在需要快速定位记录和其他类似数据地环境中，可提供极快地访问。MEMORY地缺陷是对表地大小有限制，太大的表无法缓存在内存中，其次是要确保表的数据可以恢复，数据库异常终止后表中的数据是可以恢复的。MEMORY表通常用于更新不太频繁的小表，用以快速得到访问结果。

#### MERGE

用于将一系列等同的MyISAM表以逻辑方式组合在一起，并作为一个对象引用它们。MERGE表的有点在于可以突破对单个MyISAM表大小的限制，并且通过将不同的表分布在多个磁盘上，可以有效地改善MERGE表地访问效率。这对于诸如数据仓库等VLDB环境十分合适。

